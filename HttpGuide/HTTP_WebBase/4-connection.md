# HTTP: Web基础

## 连接管理

### 输入URL获取网页的过程

1. 浏览器根据URL解析出主机名，通过DNS查询IP地址
2. 浏览器获取端口号
3. 浏览器发起到IP:Port的连接
4. 浏览器向服务器发起一条HTTP GET请求
5. 浏览器从服务器响应中读取HTTP响应报文
6. 浏览器关闭连接，并渲染页面

### HTTP是如何使用TCP连接的

TCP为HTTP提供一条可靠的比特传输管道，从TCP连接的一端填入的字节会从另一端以原有顺序，正确的传送出来

TCP的数据是通过名为IP分组的小数据块来发送的，每个IP分组都包括：
- 一个IP分组首部（通常20字节）
- 一个TCP段首部（通常20字节）
- 一个TCP数据块（0或多个字节）

在TCP连接的两端，分别进行TCP数据流与IP分组之间的分段与重装过程

TCP连接时，通过三次握手确认连接： 
- 客户端向服务器发送一个SYN标记的TCP分组数据，请求连接
- 服务器向客户端回传重置的SYN与ACK标记的TCP分组数据，表明请求已被接受
- 客户端向服务器发送ACK标记的TCP分组数据，确认连接成功建立。现代的TCP栈允许客户端在这个确认分组中发送数据

### TCP连接的时延、瓶颈以及存在的障碍

TCP的时延分为：
- 客户端根据URL解析出服务器IP地址与端口的时延，如果没有DNS缓存，则需要花费数秒时间
- 客户端与服务器确认连接成功建立的时延，也就是三次握手造成的时延
- 客户端发送请求，服务器收到请求并处理，该过程的时延
- 服务器发送响应，该过程时延

瓶颈在于几个性能区域：
- TCP连接建立握手
    > 在数据发送之前，TCP要发送两个分组来建立连接  

    > 小的HTTP事务可能会在TCP建立上花费50%以上的时间
- TCP慢启动拥塞控制
    > TCP连接会随着时间的进行自我调谐，起初会限制连接的最大速度，如果数据传送成功会随着时间的推移提高传输速度，这种调谐称为TCP慢启动, 他用于控制网络的突然过载或拥塞
- 用于捎带确认的TCP延迟确认算法
    > 每个TCP段都有一个序列号和数据完整性校验和，每个段接收者受到完好的段时，都会向发送者回传一个小的确认分组，如果发送者没有在指定时间获取到确认分组，则认为分组已被破环或损毁，并重发数据

    > 延时算确认算法会在一个特定的窗口时间100~200毫秒内将输出确认存放在缓存区，以寻找能够捎带它的输出数据分组, 如果在那段时间内没有输出数据分组，则将确认分组单独传送
- 数据聚集的Nagle算法
    > Nagle算法，试图在发送一个分组之前，将大量TCP数据绑定在一起，以提高网络效率    

    > 小的HTTP报文可能无法填满一个分组，可能会因等到那些永远不会到来的额外数据而产生时延
- TIME_WAIT时延和端口耗尽
    > 当TCP端口关闭TCP连接时，在内存中维护一个小的控制块，记录连接的IP与Port，已确保在维护的一小段时间内不会在创建具有相同IP、port的连接   

    > 当维护的TCP连接过多时，或产生端口耗尽

### HTTP的优化，并行连接、keep-alive持久连接、管道化连接

#### 并行连接

通过多条TCP连接发起并发的HTTP请求   
当网络带宽不足时，并发请求不一定更快   
浏览器存在并发连接数的限制，一般为4个

#### 持久连接

在事务处理完成后仍保持打开状态的TCP连接称为持久连接  
重用TCP连接，以消除连接及关闭时延，避免出现空闲连接

#### 管道化连接

通过共享的TCP连接发起并发的HTTP请求

### 管理连接时应该及不应该做的事情

每条HTTP响应的应该有精确的Content-Length首部

如果一个事务，不管是执行一次还是多次，得到的结果都一致，这个事务就是幂等的   
客户端不应该以管道化的方式传送非幂等的请求

实现正常关闭的应用程序首要应该关闭他们的输出通道，然后等待连接另一端的对等实体关闭他的输出通道，当两端都告诉对方不会在发送任何数据之后，连接就会被完全关闭，而不会有重置的危险